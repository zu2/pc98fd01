	ＰＣ９８０１の外付けドライブで２ＤＤを読むための実験記録
							1990.April.14
	                                                           by zukkun.

１．ＰＣ９８０１のハードウェアとソフトウェア

　ＶＭ以降のＰＣ９８０１には標準で２ＤＤ／２ＨＤの両用インターフェイスおよび両用ドライブが搭載されている．両用インターフェイスには当然，接続されているドライブを２ＤＤまたは２ＨＤに切り替えるための信号線が存在する．内蔵ドライブにはこの信号線が接続されているため自動的にモードが切り替わる．しかし，なぜか，外付け用のコネクタにはこの信号線が配線されていないため，外部にドライブを接続した場合，そのドライブは２ＨＤ専用になってしまう（これは両用インターフェイスより前に存在した２ＨＤインターフェイスとの互換を取ったためと考えられる）．

　　　ＰＣ９８０１
　　　　内蔵インターフェイス　　　　　　　　a) ２ＤＤ／２ＨＤ切替信号
　　　　　|   |                             b) その他の信号線
         a|  b+--[50ﾋﾟﾝｺﾈｸﾀ]-+
          |   |              |
　　　　内蔵ドライブ　　外付けドライブ

　さて上記の事項にかかわらず，ＰＣ９８０１のＢＩＯＳでは内蔵ドライブと外付けドライブの区別をほとんど行っていない．つまり，外付けインターフェイスに対して２ＤＤモードでの読み書きを指示することが可能である．この時，外付けドライブも２ＤＤモードであれば正常にフロッピーディスクをアクセスすることができる．


２．ＭＳ－ＤＯＳの動作

　ＭＳ－ＤＯＳでは，ドライブに挿入されたフロッピーの識別を次のシーケンスで行っていると思われる．これは私が IO.SYS を解析した結果から推論したものであり、もしかすると真っ赤な嘘かもしれない．本当の事を知っている方がおられたら教えてください．

    (1) インターフェイスのモードをデフォルト値に設定する．
        （前回、アクセスした時のモードを使用．初期値は２ＨＤ）
　　(2) ＦＡＴを読む
　　(3) 正常に読めたなら　→　デフォルトモードのフロッピーが入っている
　　(4) インターフェイスを２ＨＤモードにする．
　　(5) ＦＡＴを読む
　　(6) 正常に読めたなら　→　２ＨＤフロッピーが入っている
　　(7) インターフェイスを２ＤＤモードにする．
　　(8) ＦＡＴを読む
　　(9) 正常に読めたなら　→　２ＤＤフロッピーが入っている
　 (10) リトライの為，(1) に戻る

　この時，外付けドライブが１ＭＢモードになっていれば，(4)-(5)-(6) のシーケンスで正常にフロッピーがアクセスできる．ここで外付けドライブを２ＤＤモードにするとどうなるか？　まず，ＭＳ－ＤＯＳはＢＩＯＳの動作を２ＨＤモードに切り替える．次にＦＡＴを読みに行くのだが，なぜかフロッピーが読めてしまう（ドライブは２ＤＤモードなので２ＤＤのフロッピーなら正常に読み書きできてしまうのである）．そのためＭＳ－ＤＯＳは２ＨＤフロッピーが挿入されているものと判断してしまう．もちろんこれは大きな間違いである．実際にフロッピーを読ませてみて，chkdsk コマンドを実行するとでたらめな情報を表示する．そのため，単に両用ドライブを接続しただけでは２ＤＤのフロッピーは読み書きできない．


３．市販の外付けドライブの分類

　市販のドライブには概ね次の３種類が存在する．
　　(1) ２ＨＤ専用と称しているもの
　　(2) ２ＤＤ／２ＨＤ手動切替のもの
　　(3) ２ＤＤ／２ＨＤ自動切替のもの

　(1) は単純に拡張用のコネクタに２ＨＤドライブを接続したものである．ただし，ドライブそのものは２ＤＤ／２ＨＤ両用ドライブの場合もある．また，ドライブ側は３６ピンで信号が出ているため途中に５０ピン～３６ピンを変換する為のボードなどが必要になる．

　　　ＰＣ９８０１		外付けドライブ
	50pinｺﾈｸﾀ　<---[変換]---> 36pinｺﾈｸﾀ

　(2) は，接続するインターフェイスを切り替えることによって，２ＤＤ／２ＨＤを切り替えるものである．つまり，両用の５０ピンコネクタに接続した場合は２ＨＤ動作となり，６４０ＫＢインターフェイスに接続した場合は２ＤＤ動作となるわけである．もっとも最近のＰＣ９８０１には６４０ＫＢインターフェイスなんて内蔵されていないので，２ＤＤを使用するためには高い金を払って６４０ＫＢインターフェイスボードを買う必要がある．また，ドライブの２ＤＤ／２ＨＤの切替用スイッチが存在するものと，存在しないもの（ケーブル側で処理しているもの）がある．

　　　ＰＣ９８０１　　　　　　　　　　外付けドライブ
	　　50ﾋﾟﾝｺﾈｸﾀ <---[変換]------> 36ﾋﾟﾝｺﾈｸﾀ
                                  |         |
	拡張640KB I/F             |         +--- 2DD/2HDｽｲｯﾁ
	　　36ﾋﾟﾝｺﾈｸﾀ <-----------+

　(3) は，何らかの手段でＰＣ９８０１内の２ＤＤ／２ＨＤ切替信号を外付けドライブに接続するものである．これには，直接内部の信号を引き出してくるものと，専用のインターフェイスを用いて内部に供給されているものと同等の信号を生成するものがある．

　　　ＰＣ９８０１　　　　　　　　　　外付けドライブ
	　　50ﾋﾟﾝｺﾈｸﾀ <---[変換]------> 36ﾋﾟﾝｺﾈｸﾀ
                |                        ↑
                +-------------------------
                |               切替信号
            内蔵ドライブ


　　　ＰＣ９８０１　　　　　　　　　　外付けドライブ
	　　50ﾋﾟﾝｺﾈｸﾀ <---[変換]------> 36ﾋﾟﾝｺﾈｸﾀ
                                          ↑
            専用インターフェイス-----------
                                       生成した切替信号

　前者のタイプはスロットを専有することがないが，ＰＣ９８０１内部から信号を取り出す必要があり，後者は貴重なスロットを１つ潰してしまう．また，両者とも (2) のドライブよりもかなり割高な値段となっている．


４．ＭＳ－ＤＯＳで手動切替のドライブを活用するための実験１

　ここでは，前章(2) の様な手動切替タイプのドライブを活用するためにいくつかの実験を行ってみる．なお，手動切替用のスイッチが付いていない機種では実験は行えない．

　・２ＤＤフロッピーが読めるかどうかのテスト
　　(1) ＭＳ－ＤＯＳでフォーマット済みの２ＤＤフロッピーを１枚用意する．
　　(2) ドライブを２ＤＤモードに切り替え，フロッピーを挿入する．
　　(3) dir d: などとしてディレクトリを見る．
    (4) このとき，ファイルが１つも無い状態でディレクトリ表示が行われる．
    　　（フロッピーの内容によっては，別の表示になるかもしれませんが，
    　　　とにかく何らかの表示が行われるはずです．）

  これは２章で説明した通り，内部的には２ＨＤモードのまま２ＤＤのフロッピーが読めてしまうため，ディレクトリ情報が矛盾してしまったわけです．このままフロッピーに書き込みに行くと矛盾した情報が書かれてしまいますので絶対に書き込みを行わないこと．

  ・２ＤＤフロッピーが読めないことの確認
    (5) ドライブを２ＨＤモードに切り替える．フロッピーは２ＤＤのまま．
    (6) フロッピーを取り出して，また挿入する（バッファをクリアする）
    (7) dir d: などとしてディレクトリを見る．
    (8) 当然，エラーになるはずなので，Abort を選択して実行を中断する．

　この場合，ドライブのモードとフロッピーの種別が合わないため，データが読み出せないわけです．この時のドライブ音を注意して聞いてみてください．実際にエラーが出るまでに数回，カチャカチャとリトライしながら読み込みを行っているはずです．２章で説明したようにリトライは２ＨＤ／２ＤＤのモードを切替ながら行いますのでかなり時間がかかります．

　・２ＤＤフロッピーが正常に読めてしまうことの確認
　　（この実験は何回か試してみて，正常に読めてしまうのを確認してください）
    (8) ドライブを２ＨＤモードにする．フロッピーは２ＤＤのまま．
    (9) フロッピーを取り出して，また挿入する（バッファをクリアする）
   (10) dir d: などとしてディレクトリを見る．
   (11) リトライを繰り返している途中で，モードをいきなり２ＤＤに切り替える．
   (12) タイミング次第で２通りの反応が返ってくる．
        ・１回目の実験同様，矛盾したデータが返ってくる．
        ・なぜか正常に読めてしまう．(chkdskすると 640/720KB の容量がある）

　矛盾したデータが返ってくるのは，１回目の実験と同じ理由で，内部的には２ＨＤのままで２ＤＤのデータが読めてしまった為です．しかし，リトライの途中（内部的に２ＤＤになったタイミング）でドライブのモードが２ＤＤになった場合には，内部もドライブも２ＤＤになりますので，きちんとデータが読めてしまうわけです．

        ＰＣ９８０１側　　　　　　外付けドライブ
          まず２ＨＤで読む　　→　　ドライブは２ＨＤモードだが
            　　　　　　　　　　　　フロッピーが２ＤＤなので読むことができない．　　　　　エラーになった　　　←

　　　　　２ＤＤで読んでみる　→
　　　　　　　　　　　　　　　　　　上に同じ．読めない
　　　　　エラーになった　　　←
　　　　　　　　：
　　　　　　　　：
          ２ＨＤで読んでみる　→　　ドライブは２ＨＤモードだが
            　　　　　　　　　　　　フロッピーが２ＤＤなので読むことができない．　　　　　エラーになった　　　←
                                   （ここでドライブモードを２ＤＤに変更）
　　　　　２ＤＤで読んでみる　→    ドライブもフロッピーも２ＤＤなので
　　　　　　　　　　　　　　　　　　きちんとデータが読めた　
　　　　　正常に読めた　　　　←
　　　　　２ＤＤのフロッピーが
　　　　　入っているはず．．．

　これで一応外付けドライブで２ＤＤフロッピーが読めることが確認できました．この方法を使えば多分，ＭＳ－ＤＯＳ以外のＯＳでも２ＤＤフロッピーを読めると思います．まぁ，タイミングを見計らわないと読めないし，スイッチの寿命を縮めそうな技ですが，なんせ只で読めるのですから活用しないと損です．．．


５．ＭＳ－ＤＯＳで手動切替のドライブを活用するための実験２

　ここでは，４とは別なアプローチで手動切替タイプのドライブを活用する実験を行ってみる．実験には，ＭＳ－ＤＯＳ　ｖ３．３０Ａを使用した．

  まず、２で述べたデフォルト値格納領域の値を見てみましょう。symdeb とか適当なツールを使って、60:1760～の内容を見てみます。

>0060:1760  70 71 72 73 90 91 92 93-01 01 09 01 04 04 04 04  pqrs............

  多分、こんな内容です。違うバージョンのＭＳ－ＤＯＳだと全然違うアドレスかも知れませんので、付近のアドレスを捜して見てください。
  では、ここでドライブＢに２ＤＤのフロッピーを入れて dir b: としてから、再度 60:1760～を見てみます。

>0060:1760  70 71 72 73 90 11 92 93-01 09 09 01 04 04 04 04  pqrs............

  はい、見事に１箇所変わってますね。ここがドライブのデフォルトモードが格納されている場所です。２ＨＤが９１で２ＤＤが１１というのは、ＢＩＯＳに渡す値をそのまま格納していると思っていいみたいです。

  それでは、実験です。symdeb で 60:1766 の値を 12 にします。これで外付けドライブのモードが２ＤＤになったはずです。念のためバッファをクリアして（^Cを押して）から外付けドライブに２ＤＤのフロッピーを入れます。それからディレクトリを取ってみてください。

  多分、うまくドライブの内容が読めたと思います。ここで注意しないといけないのは、必ずＭＳ－ＤＯＳに対してフロッピーが交換された事を認識させないといけないということです。試しに、２ＨＤを読ませてから上記の操作をする（^Cを押さずに）と、変な読み方をするはずです。

  実験の追試をしやすいように、自動的に値を書き変えるプログラム（FDSET.C）を同封します。


６．ＭＳ－ＤＯＳで手動切替のドライブを活用するための実験３

  別の面からのアプローチです。上記の実験では要するに２ＨＤモードの時に正常にフロッピーが読めてしまうのがいけなかったわけです。２ＨＤ時にエラーが返ってくれば、ＭＳ－ＤＯＳが勝手に２ＤＤにリトライしてくれるのですから、エラーを返す常駐プログラムを作れば良いわけです。

  これも簡単には実験できないのでプログラム（r2dd.asm）を同封します。コマンドラインから r2dd [ﾘﾀ-ﾝ] とすると外付けドライブが２ＤＤ専用モードになります。元に戻したいときは r2dd -r [ﾘﾀ-ﾝ] です。このプログラムは実験用と言うことで、常駐解除時のチェックが甘くできています。実際の使用に当たっては充分注意してください。


７．ドライブの相性など．．．

    次のドライブでは，うまく２ＤＤが読めたそうです．
        ES2    + 自作ドライブ                     pcs29464 (zukkun)　俺だ
        PC286V + PC-LINE35(MAG LAB)               PDE00012 (くっし～)
        ?                                         pcs00433 (竹田)(r2DD)

    次の組み合せで動作が遅くなるという報告が来ています．
        RA2 + LFD-590 + 3.3A
        RA21 + PC-9831-VW2 + 3.3A                 pcs30523 (LunacyEthyl)

    次の組み合せでは残念ながら読めかったようです．
    　　PC286V + SNE MINIⅢ                       pcs31496 (正～波)
        VX21   + KMF35S(POP通商) + DOS3.3(無印)   pcs00286 (BAUMDORF)
        ?                                         pcs00433 (竹田) (FDSET)
                                                 

    報告を下さった皆様に感謝いたします．


７．その他

  ４，５，６の方法ではフロッピーを読む事はできても，フォーマットができません．ＭＳ－ＤＯＳに付属の FORMAT.EXE は，外付けドライブであることをきちんとチェックしているらしくって，コマンドを受け付けてくれません．困ったもんだ． 
  xform (いとぢゅん様作成) など，ソースが公開されている優秀なフォーマッターを改造して使うのが一番楽だと思います．実は，私もそうしています（r2DD を常駐させた状態では xform が使えます）．

  一緒に配布している追試用プログラムは LSI-C 86 試食版にてコンパイルしました。優秀なコンパイラを試食版として提供して下さった  エル・エス・アイ  ジャパン（株）にはいつも感謝しております。


８．このドキュメントの利用／配布について

　このドキュメントは，あくまでも実験記録です．したがって，この記録を元に同じ様な実験を行っても２ＤＤフロッピーが読めるとは限りません．実際，読めないという報告も来ています．追試を行って，運良く２ＤＤが読めたら報告をお願い致します．読めないという報告も歓迎いたします．

　このドキュメントと一緒に配布されているプログラム（ソースと実行形式）は追試に必要な情報として添付しているものです．追試に当たっては利用者の責任で実行を行ってください．このプログラムを実行したことで，何らかの障害が発生したとしても，私は一切の責任を負いません．くれぐれも気を付けて下さい．

　このドキュメントおよび追試用プログラムの配布は自由に行ってください．
　著作権は破棄できるものなのか良く判らないので，私（zukkun）がそのまま持つことにします．

　質問・報告等は下記のネットワークにて受け付けます．

	ＢＢＳてだこ　0988-79-6239      ID:SHIN
	アスキーネットＰＣＳ　　　　　　ID:pcs29464 (zukkun)
	ＮＩＦＴＹ　ＳＥＲＶＥ　　　　　ID:PDE00354 (zukkun)

 ＮＩＦＴＹはあまりアクセスしないので，返事が大幅に送れる可能性があります．


９．参考資料

    新版ＰＣ９８００シリーズ　テクニカルデータブック
    	アスキー出版局　テクライト編　　　　　　￥８，０００

        ↑ＢＩＯＳまわりの資料としては最強ではないかと思います。
          IO.SYS の解析に使用しました。

    別冊トランジスタ技術スペシャル　No.１１
　　　特集　フロッピーディスク・インターフェイスのすべて
　　　　ＣＱ出版社　　　　　　　　　　　　　　　￥１，５００

        ↑ＰＣ９８０１のＦＤ－ＢＩＯＳの話と、２ＨＤ／２ＤＤの接続方法が
          書いてあります。このドキュメントでの疑問は多分、この本で解決する
          でしょう。

　　フロッピ・ディスク装置のすべて
　　　高橋　昇　著　　　　ＣＱ出版社　　　　　　￥２，５００

        ↑ハードまわりの本。私の自作ＦＤＤのＶＦＯ部分の改造に役立ちました。
          ＯＡプラザで売っている外部ＶＦＯ基盤は２ＨＤ専用ですが、この本を
          参考に抵抗＋スイッチで２ＨＤ／２ＤＤ切替できるようになりました。
